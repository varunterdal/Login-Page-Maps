<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secure Location App ‚Äî Login & Map</title>
<style>
  :root{
    --bg-1: linear-gradient(120deg,#0f62fe 0%, #198038 100%);
    --card-bg:#ffffff;
    --muted:#6b7280;
    --accent:#0f62fe;
    --danger:#d93025;
    --success:#198038;
    --glass: rgba(255,255,255,0.85);
    --radius:12px;
    --shadow: 0 8px 30px rgba(2,6,23,0.18);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:var(--bg-1);color:#0b1220;}
  .app {
    min-height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:24px;
    box-sizing:border-box;
  }

  /* Auth card */
  .card {
    width:100%;
    max-width:980px;
    background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.98));
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    display:grid;
    grid-template-columns: 420px 1fr;
    min-height:520px;
  }

  /* LEFT: auth forms */
  .auth {
    padding:32px;
  }
  .brand {
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:18px;
  }
  .logo {
    width:46px;height:46px;border-radius:10px;background:linear-gradient(180deg,#0f62fe,#1987ff);
    display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
    box-shadow:0 6px 18px rgba(15,98,254,0.18);
  }
  h1{font-size:20px;margin:0 0 6px 0;}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .tabs { display:flex; gap:8px; margin-top:18px; }
  .tab {
    padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:13px;
    background:transparent; border:1px solid transparent; color:var(--muted);
  }
  .tab.active { background:rgba(15,98,254,0.08); color:var(--accent); border-color:rgba(15,98,254,0.12); }

  form { margin-top:18px; display:flex; flex-direction:column; gap:12px; }
  label{font-size:13px;color:var(--muted);}
  input[type="text"], input[type="email"], input[type="password"], input[type="number"]{
    width:100%; padding:12px 12px; border-radius:10px; border:1px solid #e6e9ef; outline:none; font-size:14px;
    box-sizing:border-box;
  }
  .row { display:flex; gap:10px; }
  .btn {
    background:var(--accent); color:#fff; padding:11px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:600;
  }
  .btn.ghost { background:transparent; color:var(--muted); border:1px solid #e6e9ef; }
  .small { font-size:13px; color:var(--muted); }

  .muted { color:var(--muted); font-size:13px; }
  .error { color:var(--danger); font-weight:600; font-size:13px; }
  .success { color:var(--success); font-weight:600; font-size:13px; }

  .pw-meter {
    height:8px; background:#f1f5f9; border-radius:6px; overflow:hidden;
  }
  .pw-meter > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#f97316,#84cc16); transition:width .25s ease; }

  /* Right side: map */
  .map-side {
    background: linear-gradient(180deg, rgba(11,18,32,0.02), rgba(11,18,32,0.02));
    padding:20px; display:flex; flex-direction:column; gap:12px;
  }
  .controls {
    display:flex; justify-content:space-between; align-items:center; gap:12px;
  }
  .btn-row { display:flex; gap:8px; align-items:center; }
  .user-bubble { display:flex; gap:10px; align-items:center; font-weight:600; color:#0b1220; }
  .user-bubble small { display:block; font-weight:400; color:var(--muted); font-size:12px; }

  .map-frame {
    flex:1; border-radius:10px; overflow:hidden; border:1px solid #e6e9ef;
    background:white; min-height:360px; position:relative;
  }
  iframe.map { width:100%; height:100%; border:0; display:block; }

  .info-panel {
    position:absolute; right:12px; bottom:12px; background:var(--glass); padding:10px 12px; border-radius:10px; font-size:13px;
    box-shadow:0 6px 20px rgba(2,6,23,0.12); backdrop-filter: blur(6px);
  }
  .fav-list { margin-top:8px; display:flex; flex-direction:column; gap:6px; }

  footer.note { text-align:center; padding:12px; color:var(--muted); font-size:12px; }

  /* Responsive */
  @media (max-width:880px){
    .card { grid-template-columns:1fr; max-width:720px; }
    .map-side { order:2; min-height:420px; }
    .auth { order:1; }
  }
</style>
</head>
<body>
<div class="app">
  <div class="card" role="application" aria-label="Auth and Map application">

    <!-- LEFT: AUTH -->
    <div class="auth" id="authPanel" aria-live="polite">
      <div class="brand">
        <div class="logo">L</div>
        <div>
          <h1>Location Hub</h1>
          <p class="lead">Secure login + location viewer ‚Äî demo (client-only)</p>
        </div>
      </div>

      <div class="tabs" role="tablist">
        <button class="tab active" id="tab-login" role="tab" aria-selected="true">Login</button>
        <button class="tab" id="tab-register" role="tab" aria-selected="false">Register</button>
        <button class="tab" id="tab-forgot" role="tab" aria-selected="false">Forgot</button>
      </div>

      <!-- LOGIN -->
      <form id="loginForm" aria-hidden="false">
        <label for="loginEmail">Email</label>
        <input id="loginEmail" type="email" autocomplete="username" placeholder="you@example.com" required />
        <label for="loginPassword">Password</label>
        <div class="row">
          <input id="loginPassword" type="password" autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
          <button type="button" class="btn ghost" id="toggleLoginPwd">Show</button>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div><label class="small"><input type="checkbox" id="rememberMe" /> Remember me</label></div>
          <a href="#" id="toVerify" style="font-size:13px;">Need verification?</a>
        </div>
        <div id="loginMessage" class="muted"></div>
        <div style="display:flex;gap:8px;">
          <button type="button" class="btn" id="doLogin">Login</button>
          <button type="button" class="btn ghost" id="gotoRegister">Create account</button>
        </div>
      </form>

      <!-- REGISTER -->
      <form id="registerForm" style="display:none;" aria-hidden="true">
        <label for="regName">Full name</label>
        <input id="regName" type="text" placeholder="Your name" required />
        <label for="regEmail">Email</label>
        <input id="regEmail" type="email" placeholder="you@example.com" required />
        <label for="regPassword">Password</label>
        <input id="regPassword" type="password" placeholder="At least 8 characters" required />
        <label for="regPasswordConfirm">Confirm password</label>
        <input id="regPasswordConfirm" type="password" placeholder="Repeat password" required />
        <div class="pw-meter" aria-hidden="true"><i id="pwMeterBar" style="width:0%"></i></div>
        <div id="pwHint" class="small muted">Use 8+ chars, mix letters, numbers & symbols</div>
        <div id="registerMessage" class="muted"></div>
        <div style="display:flex;gap:8px;">
          <button type="button" class="btn" id="doRegister">Register</button>
          <button type="button" class="btn ghost" id="gotoLoginFromReg">Back to login</button>
        </div>
      </form>

      <!-- FORGOT / RESET -->
      <form id="forgotForm" style="display:none;" aria-hidden="true">
        <label for="forgotEmail">Enter your account email</label>
        <input id="forgotEmail" type="email" placeholder="you@example.com" />
        <div id="forgotMessage" class="muted small">A temporary code will be generated (simulated).</div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button type="button" class="btn" id="doForgot">Send reset code</button>
          <button type="button" class="btn ghost" id="gotoLoginFromForgot">Back</button>
        </div>
      </form>

      <!-- VERIFY (appears as overlay replacement when needed) -->
      <form id="verifyForm" style="display:none;margin-top:12px;" aria-hidden="true">
        <label for="verifyEmail">Account</label>
        <input id="verifyEmail" type="email" readonly />
        <label for="verifyCode">Verification code</label>
        <div class="row">
          <input id="verifyCode" type="text" placeholder="6-digit code" inputmode="numeric" />
          <button type="button" class="btn ghost" id="resendOtp">Resend</button>
        </div>
        <div id="verifyMessage" class="muted small"></div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button type="button" class="btn" id="doVerify">Verify & continue</button>
          <button type="button" class="btn ghost" id="cancelVerify">Cancel</button>
        </div>
      </form>

      <footer class="note">Client-only demo. For production use secure server-side auth & OTP delivery.</footer>
    </div>

    <!-- RIGHT: MAP and controls -->
    <div class="map-side" id="mapSide" style="display:none;">
      <div class="controls">
        <div class="user-bubble" id="userInfo">
          <div style="width:42px;height:42px;border-radius:8px;background:linear-gradient(180deg,#0f62fe,#1987ff);color:white;display:flex;align-items:center;justify-content:center;font-weight:700" id="userAvatar">U</div>
          <div>
            <div id="userName">User</div>
            <small id="userEmail">you@example.com</small>
          </div>
        </div>
        <div class="btn-row">
          <button class="btn ghost" id="btnCenterDefault">Center</button>
          <button class="btn" id="btnLocate">üìç Show My Location</button>
          <button class="btn ghost" id="btnLogout">Logout</button>
        </div>
      </div>

      <div class="map-frame" aria-live="polite">
        <iframe id="gmap" class="map" loading="lazy" referrerpolicy="no-referrer-when-downgrade"
          title="Map view"></iframe>

        <div class="info-panel" id="mapInfo" style="display:none;">
          <div><strong>Coordinates:</strong> <span id="coords">‚Äî</span></div>
          <div><strong>Accuracy:</strong> <span id="accuracy">‚Äî</span></div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button class="btn ghost" id="btnCopy">Copy</button>
            <button class="btn ghost" id="btnSaveFav">Save as favorite</button>
          </div>
          <div class="fav-list" id="favList"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* -----------------------
   Utilities & Storage
   ----------------------- */
const LS_USERS = 'lh_users_v1';    // users store
const LS_SESSION = 'lh_session_v1'; // current session

function safeParse(json, fallback){ try{ return JSON.parse(json||'null')||fallback; }catch(e){ return fallback; } }
function getUsers(){ return safeParse(localStorage.getItem(LS_USERS), {}); }
function setUsers(obj){ localStorage.setItem(LS_USERS, JSON.stringify(obj)); }
function now(){ return Date.now(); }

/* Crypto: SHA-256 hash (returns hex). Browser Web Crypto API. */
async function sha256Hex(message){
  const enc = new TextEncoder().encode(message);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  const hex = Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
  return hex;
}

/* Generate a secure random token */
function randToken(len=32){
  const bytes = new Uint8Array(len/2);
  crypto.getRandomValues(bytes);
  return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* Basic email validator */
function validEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }

/* Password strength scoring (simple) */
function passwordScore(p){
  let score=0;
  if (p.length>=8) score+=1;
  if (/[A-Z]/.test(p)) score+=1;
  if (/[0-9]/.test(p)) score+=1;
  if (/[^A-Za-z0-9]/.test(p)) score+=1;
  if (p.length>=12) score+=1;
  return score; // 0-5
}

/* -----------------------
   UI bindings
   ----------------------- */
const el = id=>document.getElementById(id);

const tabs = {
  login: el('tab-login'),
  register: el('tab-register'),
  forgot: el('tab-forgot')
};
const forms = {
  login: el('loginForm'),
  register: el('registerForm'),
  forgot: el('forgotForm'),
  verify: el('verifyForm')
};

function setActiveTab(tabName){
  Object.entries(tabs).forEach(([k,btn])=>{
    const active = (k===tabName);
    btn.classList.toggle('active', active);
    btn.setAttribute('aria-selected', active?'true':'false');
  });
  forms.login.style.display = (tabName==='login') ? 'block' : 'none';
  forms.register.style.display = (tabName==='register') ? 'block' : 'none';
  forms.forgot.style.display = (tabName==='forgot') ? 'block' : 'none';
  // hide verify when switching tabs
  forms.verify.style.display = 'none';
}

/* Tab click handlers */
tabs.login.addEventListener('click', ()=>setActiveTab('login'));
tabs.register.addEventListener('click', ()=>setActiveTab('register'));
tabs.forgot.addEventListener('click', ()=>setActiveTab('forgot'));

/* Quick nav buttons */
el('gotoRegister').addEventListener('click', ()=>setActiveTab('register'));
el('gotoLoginFromReg').addEventListener('click', ()=>setActiveTab('login'));
el('gotoLoginFromForgot').addEventListener('click', ()=>setActiveTab('login'));

/* Toggle password visibility (login) */
el('toggleLoginPwd').addEventListener('click', ()=>{
  const p = el('loginPassword');
  const shown = p.type === 'text';
  p.type = shown ? 'password' : 'text';
  el('toggleLoginPwd').textContent = shown ? 'Show' : 'Hide';
});

/* Password strength indicator for register */
el('regPassword').addEventListener('input', (ev)=>{
  const v = ev.target.value || '';
  const score = passwordScore(v);
  const percent = (score/5)*100;
  el('pwMeterBar').style.width = percent+'%';
});

/* -----------------------
   Core Auth logic
   ----------------------- */

/* Create user in localStorage (passwordHash required) */
async function createUser({name, email, passwordPlain}){
  const users = getUsers();
  if (users[email]) throw new Error('Email already registered');
  const passwordHash = await sha256Hex(passwordPlain);
  users[email] = {
    name: name,
    email: email,
    passwordHash: passwordHash,
    verified: false,
    createdAt: now(),
    failedAttempts: 0,
    lockUntil: null,
    favorites: []
  };
  setUsers(users);
  return users[email];
}

/* Send (simulate) OTP */
function generateOtp(){
  return Math.floor(100000 + Math.random()*900000).toString();
}
function sendOtpToUser(email, reason='verify'){
  const users = getUsers();
  if (!users[email]) throw new Error('Unknown account');
  const otp = generateOtp();
  const expiry = now() + 5*60*1000; // 5 minutes
  users[email].pendingOtp = { code: otp, expiry: expiry, reason: reason };
  users[email].otpSentAt = now();
  setUsers(users);
  // Simulate sending: in real life send via email/SMS. For demo we log it.
  console.info(`(SIMULATED) OTP for ${email}: ${otp} (expires in 5 minutes)`);
  return otp;
}

/* Verify OTP */
function verifyOtpForUser(email, code){
  const users = getUsers();
  const u = users[email];
  if (!u || !u.pendingOtp) return { ok:false, msg:'No OTP requested' };
  if (now() > u.pendingOtp.expiry) { delete u.pendingOtp; setUsers(users); return { ok:false, msg:'OTP expired' }; }
  if (String(u.pendingOtp.code) !== String(code)) {
    return { ok:false, msg:'Incorrect code' };
  }
  // success
  delete u.pendingOtp;
  u.verified = true;
  setUsers(users);
  return { ok:true };
}

/* Login attempt */
async function attemptLogin(email, plainPassword, remember=false){
  const users = getUsers();
  const u = users[email];
  if (!u) return { ok:false, msg:'Account not found' };

  // Lockout check
  if (u.lockUntil && now() < u.lockUntil) {
    const mins = Math.ceil((u.lockUntil - now())/60000);
    return { ok:false, msg:`Account locked. Try again in ${mins} minute(s)` };
  }

  const hash = await sha256Hex(plainPassword);
  if (hash === u.passwordHash){
    // good
    u.failedAttempts = 0;
    u.lockUntil = null;
    setUsers(users);
    if (!u.verified) return { ok:false, msg:'Account not verified', needVerify:true };
    // create session
    const token = randToken(32);
    const expiry = remember ? (now() + 30*24*60*60*1000) : (now() + 60*60*1000); // 30d vs 1h
    localStorage.setItem(LS_SESSION, JSON.stringify({ email, token, expiry }));
    return { ok:true, token };
  } else {
    u.failedAttempts = (u.failedAttempts||0) + 1;
    if (u.failedAttempts >= 5){
      u.lockUntil = now() + 5*60*1000; // 5 min lock
    }
    setUsers(users);
    return { ok:false, msg:'Incorrect password' };
  }
}

/* Check session on load */
function sessionValid(session){
  return session && session.email && session.token && session.expiry && now() < session.expiry;
}

function clearSession(){ localStorage.removeItem(LS_SESSION); }

/* -----------------------
   DOM Actions: Login/Register/Verify flows
   ----------------------- */

/* Registration */
el('doRegister').addEventListener('click', async ()=>{
  const name = el('regName').value.trim();
  const email = el('regEmail').value.trim().toLowerCase();
  const pwd = el('regPassword').value;
  const conf = el('regPasswordConfirm').value;
  el('registerMessage').textContent = '';

  if (!name) return el('registerMessage').textContent = 'Enter your name';
  if (!validEmail(email)) return el('registerMessage').textContent = 'Enter a valid email';
  if (pwd !== conf) return el('registerMessage').textContent = 'Passwords do not match';
  if (passwordScore(pwd) < 3) return el('registerMessage').textContent = 'Choose a stronger password';

  try {
    await createUser({name, email, passwordPlain: pwd});
    sendOtpToUser(email, 'verify');
    // show verification form
    el('verifyEmail').value = email;
    el('verifyMessage').textContent = 'Verification code sent (simulated). Check console.';
    forms.verify.style.display = 'block';
    forms.register.style.display = 'none';
    setActiveTab('login'); // visually
  } catch (err){
    el('registerMessage').textContent = err.message || 'Registration failed';
  }
});

/* Login */
el('doLogin').addEventListener('click', async ()=>{
  const email = el('loginEmail').value.trim().toLowerCase();
  const pwd = el('loginPassword').value;
  const remember = el('rememberMe').checked;
  el('loginMessage').textContent = '';
  if (!validEmail(email)) return el('loginMessage').textContent = 'Enter valid email';
  if (!pwd) return el('loginMessage').textContent = 'Enter password';

  const res = await attemptLogin(email, pwd, remember);
  if (res.ok){
    enterApp(email);
  } else {
    if (res.needVerify){
      // show verify form
      el('verifyEmail').value = email;
      el('verifyMessage').textContent = 'Account not verified. Enter code or resend.';
      forms.verify.style.display = 'block';
      forms.login.style.display = 'none';
    } else {
      el('loginMessage').textContent = res.msg;
    }
  }
});

/* Request OTP / Forgot password */
el('doForgot').addEventListener('click', ()=>{
  const email = el('forgotEmail').value.trim().toLowerCase();
  el('forgotMessage').textContent = '';
  if (!validEmail(email)) return el('forgotMessage').textContent = 'Enter valid email';
  const users = getUsers();
  if (!users[email]) return el('forgotMessage').textContent = 'No account with that email';

  // For demo: generate OTP for reset
  sendOtpToUser(email, 'reset');
  el('verifyEmail').value = email;
  el('verifyMessage').textContent = 'Reset code sent (simulated). Check console.';
  forms.verify.style.display = 'block';
  forms.forgot.style.display = 'none';
});

/* Verify (from registration or reset) */
el('doVerify').addEventListener('click', ()=>{
  const email = el('verifyEmail').value.trim().toLowerCase();
  const code = el('verifyCode').value.trim();
  el('verifyMessage').textContent = '';
  if (!validEmail(email)) return el('verifyMessage').textContent = 'Bad account';
  if (!code) return el('verifyMessage').textContent = 'Enter code';

  const r = verifyOtpForUser(email, code);
  if (r.ok){
    el('verifyMessage').textContent = 'Verified! Signing in...';
    // auto login
    // Note: We can't validate original password here if user was resetting; for demo we consider verified and proceed.
    // Set session token
    const token = randToken(32);
    const expiry = now() + (60*60*1000);
    localStorage.setItem(LS_SESSION, JSON.stringify({ email, token, expiry }));
    setTimeout(()=>enterApp(email), 800);
  } else {
    el('verifyMessage').textContent = r.msg;
  }
});

/* Resend OTP with cooldown */
let resendCooldown = 0;
el('resendOtp').addEventListener('click', ()=>{
  const email = el('verifyEmail').value.trim().toLowerCase();
  if (!validEmail(email)) { el('verifyMessage').textContent = 'Bad account'; return; }
  if (resendCooldown > 0) { el('verifyMessage').textContent = `Please wait ${resendCooldown}s`; return; }
  try {
    sendOtpToUser(email, 'verify');
    el('verifyMessage').textContent = 'OTP resent (simulated).';
    resendCooldown = 30;
    const intv = setInterval(()=>{
      resendCooldown--; el('resendOtp').textContent = `Resend (${resendCooldown}s)`;
      if (resendCooldown<=0){ clearInterval(intv); el('resendOtp').textContent = 'Resend'; }
    },1000);
  } catch(err){
    el('verifyMessage').textContent = err.message;
  }
});

/* Cancel verify */
el('cancelVerify').addEventListener('click', ()=>{
  forms.verify.style.display='none';
  setActiveTab('login');
});

/* Link: Need verification? */
el('toVerify').addEventListener('click', (ev)=>{
  ev.preventDefault();
  const email = el('loginEmail').value.trim().toLowerCase();
  if (!validEmail(email)){ el('loginMessage').textContent='Enter email first'; return; }
  try {
    sendOtpToUser(email, 'verify');
    el('verifyEmail').value = email;
    forms.verify.style.display='block';
    forms.login.style.display='none';
    el('verifyMessage').textContent='OTP sent (simulated).';
  } catch(e){
    el('loginMessage').textContent = e.message;
  }
});

/* -----------------------
   MAP & APP UI
   ----------------------- */

const defaultCenter = { lat: 12.9716, lng: 77.5946, zoom: 12 }; // Bangalore as default

function setMapTo(lat, lng, zoom=15){
  const url = `https://www.google.com/maps?q=${lat},${lng}&z=${zoom}&output=embed`;
  el('gmap').src = url;
  el('mapInfo').style.display = 'block';
  el('coords').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  el('accuracy').textContent = '‚Äî';
}

/* Show default world/center */
el('btnCenterDefault').addEventListener('click', ()=>{
  el('gmap').src = `https://www.google.com/maps?q=${defaultCenter.lat},${defaultCenter.lng}&z=${defaultCenter.zoom}&output=embed`;
});

/* Copy coords */
el('btnCopy').addEventListener('click', async ()=>{
  const text = el('coords').textContent;
  try {
    await navigator.clipboard.writeText(text);
    alert('Coordinates copied');
  } catch(e){
    alert('Copy failed');
  }
});

/* Save favorite location for user */
el('btnSaveFav').addEventListener('click', ()=>{
  const u = currentUserEmail();
  if (!u) return;
  const coords = el('coords').textContent.split(',').map(s=>s.trim());
  if (coords.length<2) return alert('No coordinates to save');
  const lat = parseFloat(coords[0]);
  const lng = parseFloat(coords[1]);
  const users = getUsers();
  users[u].favorites = users[u].favorites || [];
  users[u].favorites.push({ lat, lng, savedAt: now() });
  setUsers(users);
  refreshFavList();
});

/* Show favorites in UI */
function refreshFavList(){
  const u = currentUserEmail();
  const container = el('favList');
  container.innerHTML = '';
  if (!u) return;
  const users = getUsers();
  const favs = (users[u].favorites || []).slice().reverse();
  if (favs.length===0) { container.innerHTML = '<small class="muted">No favorites</small>'; return; }
  favs.forEach((f, i)=>{
    const btn = document.createElement('button');
    btn.className = 'btn ghost';
    btn.style.fontSize = '13px';
    btn.textContent = `${f.lat.toFixed(5)}, ${f.lng.toFixed(5)}`;
    btn.addEventListener('click', ()=> setMapTo(f.lat, f.lng, 16));
    container.appendChild(btn);
  });
}

/* Geolocation + show in map */
el('btnLocate').addEventListener('click', ()=>{
  if (!navigator.geolocation) return alert('Geolocation not supported');
  el('btnLocate').disabled = true;
  el('btnLocate').textContent = 'Locating...';
  navigator.geolocation.getCurrentPosition((pos)=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const acc = pos.coords.accuracy;
    setMapTo(lat, lng, 16);
    el('accuracy').textContent = `${Math.round(acc)} m`;
    el('btnLocate').disabled = false;
    el('btnLocate').textContent = 'üìç Show My Location';
  }, (err)=>{
    console.error(err);
    alert('Unable to get location. Allow access or use HTTPS.');
    el('btnLocate').disabled=false;
    el('btnLocate').textContent = 'üìç Show My Location';
  },{
    enableHighAccuracy:true, timeout:15000, maximumAge:0
  });
});

/* Logout */
el('btnLogout').addEventListener('click', ()=>{
  clearSession();
  // Hide map side and show auth panel
  el('mapSide').style.display = 'none';
  el('authPanel').style.display = 'block';
  setActiveTab('login');
});

/* Current user helper */
function currentUserEmail(){
  const s = safeParse(localStorage.getItem(LS_SESSION), null);
  if (!sessionValid(s)) return null;
  return s.email;
}

/* Enter the main app after login */
function enterApp(email){
  // populate UI
  const users = getUsers();
  const u = users[email];
  if (!u) return;
  el('userName').textContent = u.name || email.split('@')[0];
  el('userEmail').textContent = u.email;
  el('userAvatar').textContent = (u.name || 'U').slice(0,1).toUpperCase();
  // show/hide panels
  el('authPanel').style.display = 'none';
  el('mapSide').style.display = 'flex';
  // load default map
  el('gmap').src = `https://www.google.com/maps?q=${defaultCenter.lat},${defaultCenter.lng}&z=${defaultCenter.zoom}&output=embed`;
  el('mapInfo').style.display = 'none';
  refreshFavList();
}

/* On load: check session */
(function init(){
  const session = safeParse(localStorage.getItem(LS_SESSION), null);
  if (sessionValid(session)){
    // session valid: auto enter
    enterApp(session.email);
    return;
  } else {
    // show auth panel
    el('authPanel').style.display = 'block';
    el('mapSide').style.display = 'none';
    setActiveTab('login');
  }
})();

/* Accessibility: Enter key support for forms */
['loginPassword','loginEmail'].forEach(id=>{
  el(id).addEventListener('keydown', (e)=>{ if (e.key==='Enter') el('doLogin').click(); });
});
['regPasswordConfirm'].forEach(id=>{
  el(id).addEventListener('keydown', (e)=>{ if (e.key==='Enter') el('doRegister').click(); });
});
['verifyCode'].forEach(id=>{
  el(id).addEventListener('keydown', (e)=>{ if (e.key==='Enter') el('doVerify').click(); });
});

/* Small demo: ensure at least one demo user exists for quick testing */
(async function seedDemo(){
  const users = getUsers();
  if (!users['demo@example.com']){
    const hash = await sha256Hex('Password123!');
    users['demo@example.com'] = {
      name: 'Demo User',
      email: 'demo@example.com',
      passwordHash: hash,
      verified: true,
      createdAt: now(),
      failedAttempts:0,
      lockUntil:null,
      favorites: [{lat:12.9716, lng:77.5946, savedAt: now()}]
    };
    setUsers(users);
    console.info('Demo user created: demo@example.com / Password123!');
  }
})();
</script>
</body>
</html>
